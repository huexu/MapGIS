/*

  ATGis.js -- AT21 century MapGis Framework

  Copyright (c) 2013 by AT21 century Contributors
*/
self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}};String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")};var ATGis=window.ATGis=function(e,t){this._init(e,t)};ATGis.REVISION="1.0";ATGis.AdaptorType=null;ATGis.extend=function(e,t){if(Object.keys){var n=Object.keys(t||{});for(var r=0,i=n.length;r<i;r++){var s=n[r];Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(t,s))}}else{var o={}.hasOwnProperty;for(var s in t){if(o.call(t,s)){e[s]=t[s]}}}return e};ATGis.combi=function(e,t){var n={}.hasOwnProperty;for(var r in t){if(n.call(t,r)){if(typeof t[r]=="object"){e[r]?false:e[r]=new Object;ATGis.combi(e[r],t[r])}else{e[r]=t[r]}}}};ATGis.prototype={adaptors:null,activeAdaptor:null,adaptorManager:null,layers:null,legends:null,_init:function(e,t){this.adaptors=e;this.layers=[];this.legends=[];ATGis.extend(this,t);this._initAdaptorManager()},init:function(){this.adaptorManager.callMethod("init")},_initAdaptorManager:function(){this.adaptorManager=new ATGis.AdaptorManager(this,this.adaptors);if(this.adaptors){this.setCurrentAdaptor(this.adaptors[0])}},setCurrentAdaptor:function(e){this.activeAdaptor=e;ATGis.AdaptorType=e.adaptorType},getCurrentAdaptor:function(){return this.activeAdaptor},zoomIn:function(){this.adaptorManager.callMethod("zoomIn",arguments)},zoomOut:function(){this.adaptorManager.callMethod("zoomOut",arguments)},zoomTo:function(e){this.adaptorManager.callMethod("zoomTo",arguments)},zoomToExtent:function(e){this.adaptorManager.callMethod("zoomToExtent",arguments)},goTo:function(e){this.adaptorManager.callMethod("goTo",arguments)},panLeft:function(){this.adaptorManager.callMethod("panLeft",arguments)},panBottom:function(){this.adaptorManager.callMethod("panBottom",arguments)},panRight:function(){this.adaptorManager.callMethod("panRight",arguments)},panTop:function(){this.adaptorManager.callMethod("panTop",arguments)},centerAt:function(e){this.adaptorManager.callMethod("centerAt",arguments)},centerZoom:function(e,t){this.adaptorManager.callMethod("centerZoom",arguments)},setCenter:function(e){this.adaptorManager.callMethod("setCenter",arguments)},getCenter:function(){return this.adaptorManager.callMethod("getCenter",arguments)},getZoom:function(){return this.adaptorManager.callMethod("getZoom",arguments)},getMaxZoom:function(){return this.adaptorManager.callMethod("getMaxZoom",arguments)},getMinZoom:function(){return this.adaptorManager.callMethod("getMinZoom",arguments)},getExtent:function(){return this.adaptorManager.callMethod("getExtent",arguments)},getPositionByPoint:function(e){return this.adaptorManager.callMethod("getPositionByPoint",arguments)},getPointByPosition:function(e){return this.adaptorManager.callMethod("getPointByPosition",arguments)},update:function(){this.adaptorManager.callMethod("update",arguments)},enableMouseWheelZoom:function(){this.adaptorManager.callMethod("enableMouseWheelZoom",arguments)},disableMouseWheelZoom:function(){this.adaptorManager.callMethod("disableMouseWheelZoom",arguments)},loadend:function(){},click:null,dblclick:null,rightclick:null,movestart:null,move:null,moveend:null,layeradded:null,layerremoved:null,zoomend:null,darg:null,dargend:null,addLayer:function(e){if(ATGis.Utils.indexOf(this.layers,e)==-1){this.adaptorManager.callMethod("addLayer",arguments);this.layers.push(e);if(e.legend&&e.legend!="null"){this.addLegend(e.legend)}}},addLayers:function(e){for(var t in e){var n=e[t];this.addLayer(n)}},removeLayer:function(e){var t=ATGis.Utils.indexOf(this.layers,e);if(t!=-1){this.adaptorManager.callMethod("removeLayer",arguments);this.layers.splice(t,1);if(e.legend){this.removeLegend(e.legend)}}},removeLayers:function(e){for(var t in e){this.removeLayer(e[t])}},createTileLayer:function(e){return this.adaptorManager.callMethod("createTileLayer",arguments)},createWMSLayer:function(e){return this.adaptorManager.callMethod("createWMSLayer",arguments)},createPOILayer:function(e){return this.adaptorManager.callMethod("createPOILayer",arguments)},addLegend:function(e){if(ATGis.Utils.indexOf(this.legends,e)==-1){this.legends.push(e)}},removeLegend:function(e){var t=ATGis.Utils.indexOf(this.legends,e);if(t!=-1){this.legends.splice(t,1)}},addControl:function(e,t,n){return this.adaptorManager.callMethod("addControl",arguments)},removeControl:function(e){this.adaptorManager.callMethod("removeControl",arguments)},hasBaseLayer:function(){return this.adaptorManager.callMethod("hasBaseLayer",arguments)},getGeometryArea:function(e,t){return this.adaptorManager.callMethod("getGeometryArea",arguments)},getGeometryLength:function(e,t){return this.adaptorManager.callMethod("getGeometryLength",arguments)}};ATGis.ALIGN_TOP_LEFT=0;ATGis.ALIGN_TOP_CENTER=1;ATGis.ALIGN_TOP_RIGHT=2;ATGis.ALIGN_BOTTOM_RIGHT=3;ATGis.ALIGN_BOTTOM_CENTER=4;ATGis.ALIGN_BOTTOM_LEFT=5;ATGis.ALIGN_CENTER_CENTER=6;ATGis.ALIGN_CENTER_LEFT=7;ATGis.ALIGN_CENTER_RIGHT=8;ATGis.JSON=self.JSON||{};ATGis.JSON.parse?true:ATGis.JSON.parse=function(json){return eval("("+json+")")};ATGis.JSON.stringify?true:ATGis.JSON.stringify=function(e){switch(typeof e){case"string":return'"'+e.replace(/(["\\])/g,"\\$1")+'"';case"array":return"["+e.map(ATGis.JSON.stringify).join(",")+"]";case"object":if(e instanceof Array){var t=[];var n=e.length;for(var r=0;r<n;r++){t.push(ATGis.JSON.stringify(e[r]))}return"["+t.join(",")+"]"}else if(obj==null){return"null"}else{var i=[];for(var s in e){i.push(s+":"+ATGis.JSON.stringify(obj[s]));return"{"+i.join(",")+"}"}};case"number":return obj;case false:return obj}};ATGis.Bounds=function(e,t,n,r){this._init(e,t,n,r)};ATGis.Bounds.prototype={constructor:ATGis.Bounds,left:null,bottom:null,right:null,top:null,centerLonLat:null,_init:function(e,t,n,r){if(e instanceof Array){t=e[1];n=e[2];r=e[3];e=e[0]}e!=null?this.left=parseFloat(e):false;t!=null?this.bottom=parseFloat(t):false;n!=null?this.right=parseFloat(n):false;r!=null?this.top=parseFloat(r):false},clone:function(){return new ATGis.Bounds(this.left,this.bottom,this.right,this.top)},equals:function(e){var t=false;if(e!=null){t=this.left==e.left&&this.right==e.right&&this.top==e.top&&this.bottom==e.bottom}return t},toString:function(){return[this.left,this.bottom,this.right,this.top].join(",")},toArray:function(e){if(e===true){return[this.bottom,this.left,this.top,this.right]}else{return[this.left,this.bottom,this.right,this.top]}},toGeometry:function(){},getWidth:function(){return this.right-this.left},getHeight:function(){return this.top-this.bottom},getCenterLonLat:function(){if(!this.centerLonLat){this.centerLonLat=new ATGis.Position((this.left+this.right)/2,(this.bottom+this.top)/2,0)}return this.centerLonLat},extend:function(e){var t=null;if(e){if(e instanceof ATGis.Position){t=ATGis.Bounds(e.x,e.y,e.x,e.y)}else if(e instanceof ATGis.Point){t=ATGis.Bounds(e.x,e.y,e.x,e.y)}else if(e instanceof ATGis.Bounds){t=e}else{}if(t){this.centerLonLat=null;if(this.left==null||t.left<this.left){this.left=t.left}if(this.bottom==null||t.bottom<this.bottom){this.bottom=t.bottom}if(this.right==null||t.right>this.right){this.right=t.right}if(this.top==null||t.top>this.top){this.top=t.top}}}},containsBounds:function(e,t,n){if(t==null){t=false}if(n==null){n=true}var r=this.contains(e.left,e.bottom,n);var i=this.contains(e.right,e.bottom,n);var s=this.contains(e.left,e.top,n);var o=this.contains(e.right,e.top,n);return t?r||i||s||o:r&&i&&s&&o},contains:function(e,t,n){if(n==null){n=true}if(e==null||t==null){return false}e=parseFloat(e);t=parseFloat(t);var r=false;if(n){r=e>=this.left&&e<=this.right&&t>=this.bottom&&t<=this.top}else{r=e>this.left&&e<this.right&&t>this.bottom&&t<this.top}return r}};ATGis.Utils=ATGis.Utils||{};ATGis.Utils.indexOf=function(e,t){var n=-1;for(var r in e){if(e[r]===t){n=r;break}}return n};ATGis.Vec2=function(e,t){this.x=e||0;this.y=t||0};ATGis.Vec2.prototype={constructor:ATGis.Vec2,set:function(e,t){this.x=e;this.y=t;return this},setX:function(e){this.x=e;return this},setY:function(e){this.y=e;return this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},copy:function(e){this.x=e.x;this.y=e.y;return this},add:function(e){this.x+=e.x;this.y+=e.y;return this},addVectors:function(e,t){this.x=e.x+t.x;this.y=e.y+t.y;return this},addScalar:function(e){this.x+=e;this.y+=e;return this},sub:function(e){this.x-=e.x;this.y-=e.y;return this},subVectors:function(e,t){this.x=e.x-t.x;this.y=e.y-t.y;return this},multiplyScalar:function(e){this.x*=e;this.y*=e;return this},divideScalar:function(e){if(e!==0){this.x/=e;this.y/=e}else{this.set(0,0)}return this},min:function(e){if(this.x>e.x){this.x=e.x}if(this.y>e.y){this.y=e.y}return this},max:function(e){if(this.x<e.x){this.x=e.x}if(this.y<e.y){this.y=e.y}return this},clamp:function(e,t){if(this.x<e.x){this.x=e.x}else if(this.x>t.x){this.x=t.x}if(this.y<e.y){this.y=e.y}else if(this.y>t.y){this.y=t.y}return this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,n=this.y-e.y;return t*t+n*n},setLength:function(e){var t=this.length();if(t!==0&&e!==t){this.multiplyScalar(e/t)}return this},lerp:function(e,t){this.x+=(e.x-this.x)*t;this.y+=(e.y-this.y)*t;return this},equals:function(e){return e.x===this.x&&e.y===this.y},fromArray:function(e){this.x=e[0];this.y=e[1];return this},toArray:function(){return[this.x,this.y]},clone:function(){return new ATGis.Vec2(this.x,this.y)}};ATGis.Point=function(e,t){ATGis.Vec2.call(this,e,t)};ATGis.Point.prototype=Object.create?Object.create(ATGis.Vec2.prototype):ATGis.extend({},ATGis.Vec2.prototype);ATGis.extend(ATGis.Point.prototype,{constructor:ATGis.Point,toString:function(){return this.x+","+this.y}});ATGis.Vec3=function(e,t,n){this.x=e||0;this.y=t||0;this.z=n||0};ATGis.Vec3.prototype={constructor:ATGis.Vec3,set:function(e,t,n){this.x=e;this.y=t;this.z=n;return this},setX:function(e){this.x=e;return this},setY:function(e){this.y=e;return this},setZ:function(e){this.z=e;return this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},copy:function(e){this.x=e.x;this.y=e.y;this.z=e.z;return this},add:function(e){this.x+=e.x;this.y+=e.y;this.z+=e.z;return this},addScalar:function(e){this.x+=e;this.y+=e;this.z+=e;return this},addVectors:function(e,t){this.x=e.x+t.x;this.y=e.y+t.y;this.z=e.z+t.z;return this},sub:function(e,t){this.x-=e.x;this.y-=e.y;this.z-=e.z;return this},subVectors:function(e,t){this.x=e.x-t.x;this.y=e.y-t.y;this.z=e.z-t.z;return this},multiply:function(e,t){if(t!==undefined){console.warn("DEPRECATED: Vector3's .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead.");return this.multiplyVectors(e,t)}this.x*=e.x;this.y*=e.y;this.z*=e.z;return this},multiplyScalar:function(e){this.x*=e;this.y*=e;this.z*=e;return this},multiplyVectors:function(e,t){this.x=e.x*t.x;this.y=e.y*t.y;this.z=e.z*t.z;return this},applyMatrix3:function(e){var t=this.x;var n=this.y;var r=this.z;var i=e.elements;this.x=i[0]*t+i[3]*n+i[6]*r;this.y=i[1]*t+i[4]*n+i[7]*r;this.z=i[2]*t+i[5]*n+i[8]*r;return this},applyMatrix4:function(e){var t=this.x,n=this.y,r=this.z;var i=e.elements;this.x=i[0]*t+i[4]*n+i[8]*r+i[12];this.y=i[1]*t+i[5]*n+i[9]*r+i[13];this.z=i[2]*t+i[6]*n+i[10]*r+i[14];return this},applyProjection:function(e){var t=this.x,n=this.y,r=this.z;var i=e.elements;var s=1/(i[3]*t+i[7]*n+i[11]*r+i[15]);this.x=(i[0]*t+i[4]*n+i[8]*r+i[12])*s;this.y=(i[1]*t+i[5]*n+i[9]*r+i[13])*s;this.z=(i[2]*t+i[6]*n+i[10]*r+i[14])*s;return this},applyQuaternion:function(e){var t=this.x;var n=this.y;var r=this.z;var i=e.x;var s=e.y;var o=e.z;var u=e.w;var a=u*t+s*r-o*n;var f=u*n+o*t-i*r;var l=u*r+i*n-s*t;var c=-i*t-s*n-o*r;this.x=a*u+c*-i+f*-o-l*-s;this.y=f*u+c*-s+l*-i-a*-o;this.z=l*u+c*-o+a*-s-f*-i;return this},transformDirection:function(e){var t=this.x,n=this.y,r=this.z;var i=e.elements;this.x=i[0]*t+i[4]*n+i[8]*r;this.y=i[1]*t+i[5]*n+i[9]*r;this.z=i[2]*t+i[6]*n+i[10]*r;this.normalize();return this},divide:function(e){this.x/=e.x;this.y/=e.y;this.z/=e.z;return this},divideScalar:function(e){if(e!==0){this.x/=e;this.y/=e;this.z/=e}else{this.x=0;this.y=0;this.z=0}return this},min:function(e){if(this.x>e.x){this.x=e.x}if(this.y>e.y){this.y=e.y}if(this.z>e.z){this.z=e.z}return this},max:function(e){if(this.x<e.x){this.x=e.x}if(this.y<e.y){this.y=e.y}if(this.z<e.z){this.z=e.z}return this},clamp:function(e,t){if(this.x<e.x){this.x=e.x}else if(this.x>t.x){this.x=t.x}if(this.y<e.y){this.y=e.y}else if(this.y>t.y){this.y=t.y}if(this.z<e.z){this.z=e.z}else if(this.z>t.z){this.z=t.z}return this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){var t=this.length();if(t!==0&&e!==t){this.multiplyScalar(e/t)}return this},lerp:function(e,t){this.x+=(e.x-this.x)*t;this.y+=(e.y-this.y)*t;this.z+=(e.z-this.z)*t;return this},cross:function(e,t){if(t!==undefined){console.warn("DEPRECATED: Vector3's .cross() now only accepts one argument. Use .crossVectors( a, b ) instead.");return this.crossVectors(e,t)}var n=this.x,r=this.y,i=this.z;this.x=r*e.z-i*e.y;this.y=i*e.x-n*e.z;this.z=n*e.y-r*e.x;return this},crossVectors:function(e,t){this.x=e.y*t.z-e.z*t.y;this.y=e.z*t.x-e.x*t.z;this.z=e.x*t.y-e.y*t.x;return this},angleTo:function(e){var t=this.dot(e)/(this.length()*e.length());return Math.acos(THREE.Math.clamp(t,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x;var n=this.y-e.y;var r=this.z-e.z;return t*t+n*n+r*r},setEulerFromRotationMatrix:function(e,t){function n(e){return Math.min(Math.max(e,-1),1)}var r=e.elements;var i=r[0],s=r[4],o=r[8];var u=r[1],a=r[5],f=r[9];var l=r[2],c=r[6],h=r[10];if(t===undefined||t==="XYZ"){this.y=Math.asin(n(o));if(Math.abs(o)<.99999){this.x=Math.atan2(-f,h);this.z=Math.atan2(-s,i)}else{this.x=Math.atan2(c,a);this.z=0}}else if(t==="YXZ"){this.x=Math.asin(-n(f));if(Math.abs(f)<.99999){this.y=Math.atan2(o,h);this.z=Math.atan2(u,a)}else{this.y=Math.atan2(-l,i);this.z=0}}else if(t==="ZXY"){this.x=Math.asin(n(c));if(Math.abs(c)<.99999){this.y=Math.atan2(-l,h);this.z=Math.atan2(-s,a)}else{this.y=0;this.z=Math.atan2(u,i)}}else if(t==="ZYX"){this.y=Math.asin(-n(l));if(Math.abs(l)<.99999){this.x=Math.atan2(c,h);this.z=Math.atan2(u,i)}else{this.x=0;this.z=Math.atan2(-s,a)}}else if(t==="YZX"){this.z=Math.asin(n(u));if(Math.abs(u)<.99999){this.x=Math.atan2(-f,a);this.y=Math.atan2(-l,i)}else{this.x=0;this.y=Math.atan2(o,h)}}else if(t==="XZY"){this.z=Math.asin(-n(s));if(Math.abs(s)<.99999){this.x=Math.atan2(c,a);this.y=Math.atan2(o,i)}else{this.x=Math.atan2(-f,h);this.y=0}}return this},setEulerFromQuaternion:function(e,t){function n(e){return Math.min(Math.max(e,-1),1)}var r=e.x*e.x;var i=e.y*e.y;var s=e.z*e.z;var o=e.w*e.w;if(t===undefined||t==="XYZ"){this.x=Math.atan2(2*(e.x*e.w-e.y*e.z),o-r-i+s);this.y=Math.asin(n(2*(e.x*e.z+e.y*e.w)));this.z=Math.atan2(2*(e.z*e.w-e.x*e.y),o+r-i-s)}else if(t==="YXZ"){this.x=Math.asin(n(2*(e.x*e.w-e.y*e.z)));this.y=Math.atan2(2*(e.x*e.z+e.y*e.w),o-r-i+s);this.z=Math.atan2(2*(e.x*e.y+e.z*e.w),o-r+i-s)}else if(t==="ZXY"){this.x=Math.asin(n(2*(e.x*e.w+e.y*e.z)));this.y=Math.atan2(2*(e.y*e.w-e.z*e.x),o-r-i+s);this.z=Math.atan2(2*(e.z*e.w-e.x*e.y),o-r+i-s)}else if(t==="ZYX"){this.x=Math.atan2(2*(e.x*e.w+e.z*e.y),o-r-i+s);this.y=Math.asin(n(2*(e.y*e.w-e.x*e.z)));this.z=Math.atan2(2*(e.x*e.y+e.z*e.w),o+r-i-s)}else if(t==="YZX"){this.x=Math.atan2(2*(e.x*e.w-e.z*e.y),o-r+i-s);this.y=Math.atan2(2*(e.y*e.w-e.x*e.z),o+r-i-s);this.z=Math.asin(n(2*(e.x*e.y+e.z*e.w)))}else if(t==="XZY"){this.x=Math.atan2(2*(e.x*e.w+e.y*e.z),o-r+i-s);this.y=Math.atan2(2*(e.x*e.z+e.y*e.w),o+r-i-s);this.z=Math.asin(n(2*(e.z*e.w-e.x*e.y)))}return this},getPositionFromMatrix:function(e){this.x=e.elements[12];this.y=e.elements[13];this.z=e.elements[14];return this},getScaleFromMatrix:function(e){var t=this.set(e.elements[0],e.elements[1],e.elements[2]).length();var n=this.set(e.elements[4],e.elements[5],e.elements[6]).length();var r=this.set(e.elements[8],e.elements[9],e.elements[10]).length();this.x=t;this.y=n;this.z=r;return this},getColumnFromMatrix:function(e,t){var n=e*4;var r=t.elements;this.x=r[n];this.y=r[n+1];this.z=r[n+2];return this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e){this.x=e[0];this.y=e[1];this.z=e[2];return this},toArray:function(){return[this.x,this.y,this.z]},clone:function(){return new THREE.Vector3(this.x,this.y,this.z)}};ATGis.Position=function(e,t,n){ATGis.Vec3.call(this,e,t,n)};ATGis.Position.prototype=Object.create?Object.create(ATGis.Vec3.prototype):ATGis.extend({},ATGis.Vec3.prototype);ATGis.extend(ATGis.Position.prototype,{constructor:ATGis.Position,toString:function(){return this.x+","+this.y+","+this.alt+","+this.heading+","+this.pitch+","+this.dis}});ATGis.Size=function(e,t){this.w=e||0;this.h=t||0};ATGis.Size.prototype={clone:function(){return new ATGis.Size(this.w,this.h)},equals:function(e){return this.w==e.w&&this.h==e.h},scale:function(e){this.w*=e;this.h*=e},toString:function(){return this.w+","+this.h}};ATGis.Adaptor=function(e,t){this._init(e,t)};ATGis.Adaptor.prototype={id:null,options:null,_init:function(e,t){this.id=e;this.options=t},init:function(){},zoomIn:function(){},zoomOut:function(){},zoomTo:function(e){},zoomToExtent:function(e){},goTo:function(e){},panLeft:function(){},panBottom:function(){},panRight:function(){},panTop:function(){},centerAt:function(e){},centerZoom:function(e,t){}};ATGis.OpenLayersAdaptor=function(e,t){ATGis.Adaptor.call(this);this._init(e,t)};ATGis.OpenLayersAdaptor.prototype=Object.create?Object.create(ATGis.Adaptor.prototype):ATGis.extend({},ATGis.Adaptor.prototype);ATGis.extend(ATGis.OpenLayersAdaptor.prototype,{constructor:ATGis.OpenLayersAdaptor,adaptorType:"OpenLayers",map:null,atgis:null,controlpanel:null,defaultOptions:{maxResolution:.703125,tileSize:512,units:"dd",projection:"EPSG:4326",numZoomLevels:24,maxExtent:[-180,-180,180,180]},init:function(){this.controlpanel=new OpenLayers.Control.Panel;this.options.controls=[new OpenLayers.Control.LTZommAnimation,new OpenLayers.Control.Zoom,this.controlpanel];var e=ATGis.extend({},this.defaultOptions);e=ATGis.extend(e,this.options);if(e.tileSize){this.setTileSize(e.tileSize);delete e.tileSize}OpenLayers.Map.prototype.resetLayersZIndex=function(){};this.map=new OpenLayers.Map(this.id,e);this.atgis.loadend();if(this.atgis.click){this.addEventListener("click",this.map,this.atgis.click)}if(this.atgis.dblclick){this.addEventListener("dblclick",this.map,this.atgis.dblclick)}if(this.atgis.rightclick){var t=this;this.addEventListener("mousedown",this.map,function(e){e.preventDefault();if(e.button==2){t.atgis.rightclick(e);return false}})}if(this.atgis.movestart){this.addEventListener("movestart",this.map,this.atgis.movestart)}if(this.atgis.move){this.addEventListener("move",this.map,this.atgis.move)}if(this.atgis.moveend){this.addEventListener("moveend",this.map,this.atgis.moveend)}if(this.atgis.zoomend){this.addEventListener("zoomend",this.map,this.atgis.zoomend)}if(this.atgis.drag){this.addEventListener("move",this.map,this.atgis.drag)}if(this.atgis.dragend){this.addEventListener("moveend",this.map,this.atgis.dragend)}},setGis:function(e){this.atgis=e},setTileSize:function(e){OpenLayers.Map.TILE_WIDTH=e;OpenLayers.Map.TILE_HEIGHT=e},zoomIn:function(){this.map.zoomIn()},zoomOut:function(){this.map.zoomOut()},zoomTo:function(e){this.map.zoomTo(e)},zoomToExtent:function(e){this.map.zoomToExtent(new OpenLayers.Bounds(e.left,e.bottom,e.right,e.top))},goTo:function(e){this.centerAt(e)},panLeft:function(){this.map.pan(50,0)},panBottom:function(){this.map.pan(0,-50)},panRight:function(){this.map.pan(-50,0)},panTop:function(){this.map.pan(0,50)},centerAt:function(e){this.map.setCenter(new OpenLayers.LonLat(e.x,e.y))},centerZoom:function(e,t){this.map.setCenter(new OpenLayers.LonLat(e.x,e.y),t)},setCenter:function(e){this.map.setCenter(new OpenLayers.LonLat(e.x,e.y))},getCenter:function(){var e=this.map.getCenter();return new ATGis.Position(e.lon,e.lat)},getZoom:function(){return this.map.getZoom()},getMaxZoom:function(){return this.map.numZoomLevels},getMinZoom:function(){return 0},getExtent:function(){return this.map.getExtent()},getPositionByPoint:function(e){var t=this.map.getLonLatFromPixel(e);return new ATGis.Position(t.lon,t.lat,0)},getPointByPosition:function(e){return this.map.getPixelFromLonLat(new OpenLayers.LonLat(e.x,e.y))},update:function(){this.map.updateSize()},enableMouseWheelZoom:function(){var e=this.map.getControlsByClass("OpenLayers.Control.Navigation");if(e){var t=e[0];t.enableZoomWheel()}},disableMouseWheelZoom:function(){var e=this.map.getControlsByClass("OpenLayers.Control.Navigation");if(e){var t=e[0];t.disableZoomWheel()}},addLayer:function(e){if(!this.hasBaseLayer()){e.options.isBaseLayer=true}e.setAdaptor(this);this.map.addLayer(e.adaptorLayer);if(this.atgis.layeradded){this.atgis.layeradded(e)}},addLayers:function(e){for(var t in e){var n=e[t];this.addLayer(n)}},removeLayer:function(e){this.map.removeLayer(e.adaptorLayer);if(this.atgis.layerremoved){this.atgis.layerremoved(e)}},removeLayers:function(e){for(var t in e){this.removeLayer(e[t])}},reLoadLayer:function(e,t){if(e.type==="WMSLayer"){e.adaptorLayer.mergeNewParams(t)}},createLayer:function(e){var t;if(e.options.layerName){if(OpenLayers.Layer[e.options.layerName]){t=new OpenLayers.Layer[e.options.layerName](e.name,e.options);return t}}return null},createTileLayer:function(e){var e=new OpenLayers.Layer.TileLayer(e.name,e.url,e.options);return e},createWMSLayer:function(e){var t=new OpenLayers.Layer.WMS(e.name,e.url,e.params,e.options);t.spetialQueryable=e.spetialQueryable;t.restIDs=e.restIDs;return t},createPOILayer:function(e){var t=new OpenLayers.Layer.PoiLayer(e.name,e.options);t.spetialQueryable=e.spetialQueryable;return t},createVectorLayer:function(e){if(e.options.style){var t=new OpenLayers.Style;t.addRules([new OpenLayers.Rule({symbolizer:e.options.style})]);var n=new OpenLayers.StyleMap({"default":t});delete e.options.style;e.options.styleMap=n}var r=new OpenLayers.Layer.Vector(e.name,e.options);return r},createFileLayer:function(e){return null},addControl:function(e,t,n){if(OpenLayers.Control[e]){var r=new OpenLayers.Control[e](t);if(r.type==OpenLayers.Control.TYPE_TOOL||r.type==OpenLayers.Control.TYPE_TOGGLE||r.type==OpenLayers.Control.TYPE_BUTTON){this.controlpanel.addControls([r])}else{this.map.addControl(r)}console.log("添加了控件"+e);return r}return null},removeControl:function(e){var t="OpenLayers.Control."+e;var n=this.map.getControlsByClass(t);if(n.length){this.map.removeControl(n[0])}},getControl:function(e){var t="OpenLayers.Control."+e;var n=this.map.getControlsByClass(t);if(n.length){return n[0]}return null},activeControl:function(e){if(typeof e=="string"){e=this.getControl(e)}if(!e){return}if(e.type==OpenLayers.Control.TYPE_BUTTON){e.trigger();return}if(e.type==OpenLayers.Control.TYPE_TOGGLE){if(e.active){e.deactivate()}else{e.activate()}return}var t;for(var n=0,r=this.map.controls.length;n<r;n++){t=this.map.controls[n];if(t!=e&&(t.type===OpenLayers.Control.TYPE_TOOL||t.type==null)){t.deactivate()}}e.activate()},createFeatureByWKT:function(e){var t=new OpenLayers.Format.WKT;var n=t.read(e);return n},addEventListener:function(e,t,n){t.events.register(e,t,n)},removeEventListener:function(e,t,n){t.events.unregister(e,t,n)},hasBaseLayer:function(){return this.map.baseLayer!==null},getGeometryArea:function(e,t){var n=e.getArea();var r=this.map.getUnits();var i=OpenLayers.INCHES_PER_UNIT[t];if(i){var s=OpenLayers.INCHES_PER_UNIT[r];n*=Math.pow(s/i,2)}return n},getGeometryLength:function(e,t){var n=e.getLength();var r=this.map.getUnits();var i=OpenLayers.INCHES_PER_UNIT[t];if(i){var s=OpenLayers.INCHES_PER_UNIT[r];n*=s/i}return n}});ATGis.Layer=function(e,t,n){this._init(e,t,n)};ATGis.Layer.prototype={name:null,url:null,options:null,type:null,adaptorLayer:null,adaptor:null,legend:null,spetialQueryable:false,_init:function(e,t,n){ATGis.extend(this,n);this.name=e;this.url=t;this.options=n},setAdaptor:function(e){this.adaptor=e;this.adaptorLayer=this._createAdaptorLayer()},_createAdaptorLayer:function(){var e=this.adaptor.createLayer(this);return e},clone:function(){return this._callMethod("clone",arguments)},getVisibility:function(){return this._callMethod("getVisibility",arguments)},setVisibility:function(e){return this._callMethod("setVisibility",arguments)},setIsBaseLayer:function(e){return this._callMethod("setIsBaseLayer",arguments)},setOpacity:function(e){return this._callMethod("setOpacity",arguments)},getZIndex:function(){return this._callMethod("getZIndex",arguments)},setZIndex:function(e){return this._callMethod("setZIndex",arguments)},_callMethod:function(e,t){if(this.adaptorLayer){return this.adaptorLayer[e].apply(this.adaptorLayer,t)}else{console.log("当前图层的适配器图层没有初始化 先初始化该图层！");return null}}};ATGis.POILayer=function(e,t){ATGis.Layer.call(this,e,null,t)};ATGis.POILayer.prototype=Object.create?Object.create(ATGis.Layer.prototype):ATGis.extend({},ATGis.Layer.prototype);ATGis.extend(ATGis.POILayer.prototype,{constructor:ATGis.POILayer,type:"POILayer",_createAdaptorLayer:function(){var e=this.adaptor.createPOILayer(this);return e}});ATGis.AdaptorManager=function(e,t){this._init(e,t)};ATGis.AdaptorManager.prototype={adaptors:null,atgis:null,_init:function(e,t){this.adaptors=t||[];this.atgis=e;for(var n=0;n<this.adaptors.length;n++){this.adaptors[n].setGis(e)}},callMethod:function(e,t){var n={};for(var r in this.adaptors){var i=this.adaptors[r];if(typeof i[e]==="function"){var s=i[e].apply(i,t||[]);n[i.id]=s}}if(this.adaptors.length>1){return n}else{return n[this.adaptors[0].id]}},addAdaptor:function(e){this.adaptors.push(e);e.setGis(this.atgis);this.atgis.adaptors=this.adaptors;e.init()},removeAdaptor:function(e){var t=ATGis.Utils.indexOf(this.adaptors,e);if(t!==-1){this.adaptors.splice(t,1);this.atgis.adaptors=this.adaptors}}};ATGis.VectorLayer=function(e,t){t=t||{};var n={};ATGis.combi(n,this.defaultSymbolizers);ATGis.combi(n,t.style);t.style=n;ATGis.Layer.call(this,e,null,t)};ATGis.VectorLayer.prototype=Object.create?Object.create(ATGis.Layer.prototype):ATGis.extend({},ATGis.Layer.prototype);ATGis.extend(ATGis.VectorLayer.prototype,{constructor:ATGis.VectorLayer,defaultSymbolizers:{Point:{pointRadius:3,graphicName:"square",fillColor:"#8AC4F0",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#FAD00B"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#ee9900",strokeDashstyle:"solid"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#ee9900",fillColor:"#66cccc",fillOpacity:.3}},_createAdaptorLayer:function(){var e=this.adaptor.createVectorLayer(this);return e},add:function(e){if(e&&!(e instanceof Array)){e=[e]}var t=[];for(var n in e){var r=e[n];var i=this.adaptor.createFeatureByWKT(r.geometry);ATGis.extend(i.attributes,r.attributes);if(!i.fid){i.fid="feature_"+parseInt(Math.random()*Math.pow(10,17))}t.push(i)}this.addOrigFeatures(t)},remove:function(e){if(e&&!(e instanceof Array)){e=[e]}this.adaptorLayer.removeFeatures(e)},addOrigFeatures:function(e){if(e&&!(e instanceof Array)){e=[e]}this.adaptorLayer.addFeatures(e)},removeOrigFeatures:function(e){if(e&&!(e instanceof Array)){e=[e]}this.adaptorLayer.removeFeatures(e)},clear:function(){this.adaptorLayer.removeAllFeatures()},addWKT:function(e){var t=this.adaptor.createFeatureByWKT(e);this.addOrigFeatures(t);return t},getFeatures:function(){return this.adaptorLayer.features},addEventListener:function(e,t){this.adaptor.addEventListener(e,this.adaptorLayer,t)},removeEventListener:function(e,t){this.adaptor.removeEventListener(e,this.adaptorLayer,t)}});ATGis.TileLayer=function(e,t,n){ATGis.Layer.call(this);var r=ATGis.extend({},this.defaultOptions);r=ATGis.extend(r,n);this._init(e,t,r)};ATGis.TileLayer.prototype=Object.create?Object.create(ATGis.Layer.prototype):ATGis.extend({},ATGis.Layer.prototype);ATGis.extend(ATGis.TileLayer.prototype,{constructor:ATGis.TileLayer,defaultOptions:{isBaseLayer:false},type:"TileLayer",_createAdaptorLayer:function(){var e=this.adaptor.createTileLayer(this);return e}});ATGis.SpetialQuery=function(e,t,n){this.adaptor=e;this.queryType=t;n?this.setProxy(n):false;var r=this;if(t===ATGis.SpetialQuery.POINT){this.control=e.addControl("PointQuery",{proxy:n,queryend:function(){r.queryEnd.apply(r,arguments)}})}if(t===ATGis.SpetialQuery.RECT){this.control=e.addControl("RectQuery",{proxy:n,queryend:function(){r.queryEnd.apply(r,arguments)}})}if(t===ATGis.SpetialQuery.POLYGON){this.control=e.addControl("PolygonQuery",{proxy:n,queryend:function(){r.queryEnd.apply(r,arguments)}})}};ATGis.SpetialQuery.prototype={proxy:null,queryType:null,url:null,querybox:null,adaptor:null,control:null,setProxy:function(e){this.proxy=e},getQueryBbox:function(){return this.querybox},setQueryBbox:function(e){this.querybox=e},queryEnd:function(e){},getQueryURL:function(){var e=this.url;if(this.proxy){e=this.proxy+"?url="+escape(e)}return e}};ATGis.SpetialQuery.POINT="point";ATGis.SpetialQuery.RECT="rect";ATGis.SpetialQuery.POLYGON="polygon";ATGis.FileLayer=function(e,t,n){ATGis.Layer.call(this,e,t,n)};ATGis.FileLayer.prototype=Object.create?Object.create(ATGis.Layer.prototype):ATGis.extend({},ATGis.Layer.prototype);ATGis.extend(ATGis.FileLayer.prototype,{constructor:ATGis.FileLayer,type:"FileLayer",_createAdaptorLayer:function(){var e=this.adaptor.createFileLayer(this);return e}});ATGis.RouteAnalysis=function(e,t,n,r,i){this.adaptor=e;this.proxy=n;this.server=t;this.startIcon=r;this.endIcon=i;var s=this;this.route=e.addControl("RouteAnalysis",{proxy:n,server:t,startIcon:r,endIcon:i,queryend:function(){s.queryEnd.apply(s,arguments)}})};ATGis.RouteAnalysis.prototype={porxy:null,server:null,adaptor:null,setProxy:function(e){this.proxy=e},queryEnd:function(e){},destroy:function(){this.route.deactivate();this.adaptor.removeControl(this.route)}};ATGis.BufferAnalysis2=function(e,t,n,r){this.adaptor=e;this.server=t;this.proxy=r;this.radius=n;var i=this;var s=e.addControl("BufferAnalysis2",{server:t,proxy:r,radius:n,queryend:function(){i.queryEnd.apply(i,arguments)}})};ATGis.BufferAnalysis2.prototype={setRadius:function(e){this.radius=e},getRadius:function(){return this.radius}};ATGis.Buffer=function(e){this._init(e)};ATGis.Buffer.prototype={server:null,geometry:null,distance:null,type:ATGis.Buffer.OUTSIDE,dataType:"json",format:"json",success:null,error:null,vectorLayer:null,_init:function(e){ATGis.extend(this,e);if(!this.server){throw"服务地址没有设置 new ATGis.Buffer({server: '', geometry: '', distance: 100, type: '',success:'', error: ''})"}if(!this.geometry){throw"缓冲空间对象没有设置 new ATGis.Buffer({server: '', geometry: '', distance: 100, type: '',success:'', error: ''})"}if(!this.distance){throw"缓冲距离没有设置 new ATGis.Buffer({server: '', geometry: '', distance: 100, type: '',success:'', error: ''})"}this.doExecute()},doExecute:function(){var e=this;var t={geometry:this.geometry,distance:this.distance};$.ajax({url:this.server,type:"POST",dataType:this.dataType,async:true,data:t,success:function(t){e._parseData(t);if(e.vectorLayer&&e.vectorLayer instanceof ATGis.VectorLayer){e.vectorLayer.add(e.data.features)}if(e.success){e.success(e.data)}},error:function(t){if(e.error){e.error(t)}}})},_parseData:function(e){if(this.format=="json"){if(typeof e=="string"){this.data=ATGis.JSON.parse(e)}else{this.data=e}}if(this.format=="xml"){this._parseXML(e)}},_parseXML:function(e){var t=$(e);var n=t;if(t[0].nodeType==8){n=t.eq(1)}if(t[0].nodeType==9){n=t.children()}if(n.attr("success")===ATGis.Buffer.SUCCESS){this.data={success:true,features:[]};var r=n.find("feature");var i=this;r.each(function(){var e={};i._parseFeature(this,e);i.data.features.push(e)})}},_parseFeature:function(e,t){var n=$(e).children("attributes");var r=$(e).children("geometry");var i=r[0].firstChild?r[0].firstChild.nodeValue:null;t.attributes={};t.geometry=i;n.children().each(function(){var e=this.tagName;var n=this.firstChild?this.firstChild.nodeValue:null;t.attributes[e]=n})},getDistance:function(){return this.distance}};ATGis.Buffer.INSET="inset";ATGis.Buffer.OUTSIDE="outside";ATGis.Buffer.SUCCESS="true";ATGis.WMSLayer=function(e,t,n,r){ATGis.Layer.call(this);var i=ATGis.extend({},this.defaultOptions);i=ATGis.extend(i,r);this._init(e,t,i);var s=ATGis.extend({},this.defaultParams);s=ATGis.extend(s,n);this.params=s};ATGis.WMSLayer.prototype=Object.create?Object.create(ATGis.Layer.prototype):ATGis.extend({},ATGis.Layer.prototype);ATGis.extend(ATGis.WMSLayer.prototype,{constructor:ATGis.WMSLayer,defaultOptions:{isBaseLayer:false,transitionEffect:"resize"},defaultParams:{transparent:true},type:"WMSLayer",params:null,_createAdaptorLayer:function(){var e=this.adaptor.createWMSLayer(this);return e},reLoad:function(e){this.adaptor.reLoadLayer(this,e)}});ATGis.CEarthAdaptor=function(e,t){ATGis.Adaptor.call(this);this._init(e,t)};ATGis.CEarthAdaptor.prototype=Object.create?Object.create(ATGis.Adaptor.prototype):ATGis.extend({},ATGis.Adaptor.prototype);ATGis.extend(ATGis.CEarthAdaptor.prototype,{constructor:ATGis.CEarthAdaptor,adaptorType:"CEarth",world:null,atgis:null,controlpanel:null,init:function(){if(this.options&&this.options.tileSize){this.setTileSize(this.options.tileSize);delete this.options.tileSize}this.world=new CEarth.World(this.id,this.options);var e=new CEarth.Stars(this.world);this.atgis.loadend()},setGis:function(e){this.atgis=e},setTileSize:function(e){CEarth.World.TILE_WIDTH=e;CEarth.World.TILE_HEIGHT=e},zoomIn:function(){this.world.zoomIn()},zoomOut:function(){this.world.zoomOut()},zoomTo:function(e){this.world.zoomTo(e)},zoomToExtent:function(e){this.world.zoomToExtent(e)},goTo:function(e,t){this.centerAt(e,t)},panLeft:function(){},panBottom:function(){},panRight:function(){},panTop:function(){},centerAt:function(e,t){this.world.flyTo(new CEarth.Position(e.x,e.y,e.z,t))},centerZoom:function(e,t){},setCenter:function(e){},getCenter:function(){var e=this.world.getCenter();return new ATGis.Position(e.lon,e.lat,e.alt)},getZoom:function(){return this.world.getZoom()},getMaxZoom:function(){return this.world.maxZoom},getMinZoom:function(){return this.world.minZoom},getExtent:function(){},getPositionByPoint:function(e){return this.world.getPositionByPoint(e)},getPointByPosition:function(e){return this.world.getWorldPointByPosition(new CEarth.Position(e.x,e.y,e.z))},update:function(){this.world.draw()},enableMouseWheelZoom:function(){this.world.control.userZoom=true},disableMouseWheelZoom:function(){this.world.control.userZoom=false},addLayer:function(e){e.setAdaptor(this);this.world.addLayer(e.adaptorLayer);if(this.atgis.layeradded){this.atgis.layeradded(e)}},addLayers:function(e){for(var t in e){var n=e[t];this.addLayer(n)}},removeLayer:function(e){this.world.removeLayer(e.adaptorLayer);if(this.atgis.layerremoved){this.atgis.layerremoved(e)}},createTileLayer:function(e){return e},createWMSLayer:function(e){var t=new CEarth.WMSLayer(e.name,e.url,e.options);t.spetialQueryable=e.spetialQueryable;t.restIDs=e.restIDs;return t},createPOILayer:function(e){var t=new CEarth.Markers(e.name,e.options);return t},createVectorLayer:function(e){return null},createFileLayer:function(e){return null},addControl:function(e,t,n){return null},removeControl:function(e){},getControl:function(e){return null},createFeatureByWKT:function(e){return fs},addEventListener:function(e,t,n){t.events.on(e,n)},removeEventListener:function(e,t,n){t.events.un(e,n)}});ATGis.Measure=function(e,t){this.adaptor=e;this.measuretype=t;var n=this;if(this.measuretype===ATGis.Measure.DISTANCE){var r=this.adaptor.addControl("MeasureDistance");this.control=r;if(r){r.mesureend=function(e,t,r){n.setLength(e);n.units=t;n.measureEnd.apply(n,arguments)}}}if(this.measuretype===ATGis.Measure.AREA){var i=this.adaptor.addControl("MeasureArea");this.control=i;if(i){i.mesureend=function(e,t,r){n.setArea(e);n.units=t;n.measureEnd.apply(n,arguments)}}}};ATGis.Measure.prototype={length:null,units:null,area:null,measuretype:null,onTerrain:false,getLength:function(){return this.length},setLength:function(e){this.length=e},getArea:function(){return this.area},setArea:function(e){this.area=e},setOnTerrain:function(e){this.onTerrain=e},getOnTerrain:function(){return this.onTerrain},measureEnd:function(e){}};ATGis.Measure.DISTANCE="distance";ATGis.Measure.AREA="area";ATGis.History={history:[],pointer:-1,atgis:null,add:function(e){if(this.pointer>=0){this.history=this.history.slice(0,this.pointer+1)}this.history.push(e);this.pointer++},back:function(){if(this.pointer<=0){return null}this.pointer--;var e=this.history[this.pointer];if(this.atgis){this.atgis.zoomToExtent(e,true)}return e},forword:function(){if(this.pointer>=this.history.length-1){return null}this.pointer++;var e=this.history[this.pointer];if(this.atgis){this.atgis.zoomToExtent(e,true)}return e}};ATGis.BufferAnalysis=function(e,t){this.adaptor=e;this._init(t)};ATGis.BufferAnalysis.prototype={server:null,distance:null,vectorLayer:null,type:ATGis.BufferAnalysis.POINT,persist:false,_init:function(e){ATGis.extend(this,e);if(!e.server){throw"缺少参数server，new ATGis.BufferAnalysis(adaptor,{server: '',distance:''})"}if(!e.distance){throw"缺少参数distance，new ATGis.BufferAnalysis(adaptor,{server: '',distance:''})"}var t=this;var n;if(this.type==ATGis.BufferAnalysis.POINT){n="BufferPointAnalysis"}if(this.type==ATGis.BufferAnalysis.LINE){n="BufferLineAnalysis"}if(this.type==ATGis.BufferAnalysis.POLYGON){n="BufferPolygonAnalysis"}var r=this.adaptor.addControl(n,{queryend:function(e){if(t.persist){t.vectorLayer.addWKT(e)}var n=new ATGis.Buffer({server:t.server,geometry:e,distance:t.distance,dataType:"JSONP",format:"json",vectorLayer:t.vectorLayer,success:function(){if(t.queryEnd){t.queryEnd(n)}},error:function(){}})},layer:t.vectorLayer.adaptorLayer});this.control=r},setDistance:function(e){this.distance=e},getDistance:function(){return this.distance},queryEnd:function(e){}};ATGis.BufferAnalysis.POINT="point";ATGis.BufferAnalysis.LINE="line";ATGis.BufferAnalysis.POLYGON="polygon"