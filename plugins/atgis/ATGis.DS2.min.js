/*

  ATGis.js -- AT21 century MapGis Framework

  Copyright (c) 2013 by AT21 century Contributors
*/
ATGis.DS=function(e,t,n,r){this._init(e,t,n,r)};ATGis.DS.prototype={url:null,data:null,atgis:null,layers:null,type:"xml",async:true,_init:function(e,t,n,r){this.url=e;if(typeof t=="function"){r=t;t=null}if(typeof n=="function"){r=n;n=null}this.atgis=t;ATGis.extend(this,n);this.layers=[];this._query(r)},_query:function(e){var t=this;ATGis.DS.get(this.url,this.type,this.async,function(n){t.data=n;t.createLayers();if(t.atgis){if(!t.atgis.layers||t.atgis.layers.length==0){t.layers[0].options.isBaseLayer=true}t.atgis.addLayers(t.layers)}e?e(t):false})},createLayers:function(){for(var e in this.data){var t=this.data[e];var n=this.createLayer(t);if(n){n.legend=t.legend;n.legend?n.legend.layer=n:false;this.layers.push(n)}}},createLayer:function(e){},getLayers:function(){return this.layers}};ATGis.DS.SUCCESS="success";ATGis.DS.TAGTILELAYER="tilelayer";ATGis.DS.TAGWMSLAYER="wmslayer";ATGis.DS.TAGPOILAYER="poilayer";ATGis.DS.getTimes=function(e,t,n){n=n||"xml";var r;$.ajax({type:"GET",url:e,dataType:n,async:false,success:function(e){var n=ATGis.DS.getXMLRoot(e);var i=n.find("time");if(i.length){r=[];i.each(function(){var e=this.firstChild.nodeValue;r.push(e)});if(t){t(r)}}}});return r};ATGis.DS.getXMLRoot=function(e){if(typeof e=="string"){if($.browser.msie&&$.browser.version<10){var t=new ActiveXObject("Microsoft.XMLDOM");t["loadXML"](e);e=$(t)}else{var n=new DOMParser;var t=n.parseFromString(e,"text/xml");e=$(t)}}else{e=$(e)}var r=e;if(e[0].nodeType==9){r=e.children()}else if(e[0].nodeType==8){r=e.eq(1)}return r};ATGis.DS.get=function(e,t,n,r){t=t||"xml";n=n==undefined||n==null?true:n;$.ajax({type:"GET",url:e,dataType:t,async:n,success:function(e){var t=ATGis.DS.getXMLRoot(e);var n=ATGis.DS.parse(t);r?r(n):false}})};ATGis.DS.parse=function(e){if(e.attr("flag")===ATGis.DS.SUCCESS){var t=e.children("item").children();var n=[];t.each(function(){var e=this;var t=e.tagName.toLowerCase();if(t==ATGis.DS.TAGTILELAYER){var r={layertype:ATGis.DS.TAGTILELAYER};ATGis.DS._parse(r,$(e));n.push(r)}else if(t==ATGis.DS.TAGWMSLAYER){var r={layertype:ATGis.DS.TAGWMSLAYER};ATGis.DS._parse(r,$(e));n.push(r)}});var r=ATGis.DS._parsePOI(e);if(r){r.layertype=ATGis.DS.TAGPOILAYER;n.push(r)}return n}if(e.attr("success")==="true"){var i=e.find("table");var n=[];i.each(function(){var e=this;var t=ATGis.DS._parsePOI($(e));if(t){t.layertype=ATGis.DS.TAGPOILAYER;n.push(t)}});return n}return null};ATGis.DS._parse=function(e,t){t.children().each(function(){var n=this.tagName.toLowerCase();var r=null;if(!$(this).children().length){r=this.firstChild?this.firstChild.nodeValue:r}else{if(n=="legend"){r={};ATGis.DS._parseLegend(r,$(this),1,t[0].tagName)}else{r={};ATGis.DS._parse(r,$(this))}}e[n]=e[n]?[].concat(e[n],r):r})};ATGis.DS._parsePOI=function(e){var t=e.children("records");if(t.length){var n=e.children("metas");var r={};if(n.length){ATGis.DS._parseAttribute(r,n[0]);r.fields=[];n.children("field").each(function(){var e={};ATGis.DS._parseAttribute(e,this);r.fields.push(e)})}var i=[];t.children("record").each(function(){var e={};$(this).children("field").each(function(){var t=$(this).attr("id");var n=this.firstChild?this.firstChild.nodeValue:null;if(n){e[t]=n}});i.push(e)});return{metas:r,records:i}}return null};ATGis.DS._parseAttribute=function(e,t){for(var n=0;n<t.attributes.length;n++){var r=t.attributes[n];e[r.name]=r.value}};ATGis.DS._parseLegend=function(e,t,n,r){if(t.children("legenditem").length){e.children=[]}t.children("legenditem").each(function(){var t={level:n,parent:e,type:r};ATGis.DS._parseLegendItem(t,this,n,r);e.children.push(t)});return e};ATGis.DS.legendID=1;ATGis.DS._parseLegendItem=function(e,t,n,r){var i=$(t).children("name")[0];var s=i.firstChild?i.firstChild.nodeValue:null;var o=$(t).children("title")[0];var u=o.firstChild?o.firstChild.nodeValue:null;var a=$(t).children("img")[0];var f=a.firstChild?a.firstChild.nodeValue:null;e.name=s;e.title=u;e.img=f;e.text=u||"";e.icon=f||"";e.checked=1;e.id="legend_"+ATGis.DS.legendID++;if($(t).children("legenditem").length){e.children=[]}$(t).children("legenditem").each(function(){var t={level:n+1,parent:e,type:r};ATGis.DS._parseLegendItem(t,this,n+1);e.children.push(t)})};ATGis.DS.Buffer=function(e,t){var n={};this.vectorLayer=t.vectorLayer;t.vectorLayer?delete t.vectorLayer:false;if(t.success){this.success=t.success;delete t.success}if(t.error){this.error=t.error;delete t.error}ATGis.extend(n,this.defaultParams);ATGis.extend(n,t);this._init(e,n)};ATGis.DS.Buffer.prototype={server:null,params:null,vectorLayer:null,_init:function(e,t){this.server=e;this.params=t;this._query()},_query:function(){var e=this.params.geometry;var t=this.getGeometryType(e);var n=ATGis.JSON.stringify(this.params);var r=this.server+n;if(this.params.dataType==="JSONP"){r+="&callback=?"}var i=this;var s=new ATGis.Buffer({server:r,geometry:e,distance:this.params.distance,dataType:this.params.dataType||"JSONP",format:this.params.format||"json",vectorLayer:this.vectorLayer,success:function(){if(i.success){i.success(s)}},error:function(){if(i.error){i.error()}}})},getGeometryType:function(e){var t=/^\s*(\w+)\s*\(\s*(.*)\s*\)\s*$/;var n=t.exec(e);var r=null;if(n){var i=n[1].toLowerCase();switch(i){case"point":{r=ATGis.DS.Buffer.POINT;break};case"linestring":{r=ATGis.DS.Buffer.LINE;break};case"polygon":{r=ATGis.DS.Buffer.POLYGON;break}}}return r}};ATGis.DS.Buffer.POINT="esriGeometryPoint";ATGis.DS.Buffer.LINE="esriGeometryPolyline";ATGis.DS.Buffer.POLYGON="esriGeometryPolygon";ATGis.DS.SpecialQuery=function(e,t){this._init(e,t)};ATGis.DS.SpecialQuery.prototype={server:null,geometry:null,type:[],dataType:"xml",_init:function(e,t){ATGis.extend(this,t);this.server=e},query:function(e,t){$.ajax({type:"POST",url:this.server,data:e,dataType:this.dataType||"JSONP",success:function(e){t?t(e):false}})},queryEnd:function(e){}};ATGis.DS.POI=function(e,t,n,r){ATGis.DS.call(this,e,t,n,r)};ATGis.DS.POI.prototype=Object.create?Object.create(ATGis.DS.prototype):ATGis.extend({},ATGis.DS.prototype);ATGis.extend(ATGis.DS.POI.prototype,{constructor:ATGis.DS.POI,icon:null,align:"bottom_center",spetialQueryable:false,createLayer:function(e){if(e.layertype===ATGis.DS.TAGPOILAYER){var t=e.records;var n=t[0]["type"]||t[0]["TYPE"];var r={};this.icon=this.icon||"";r[n]={icon:this.icon.replace("#{icon}",n),align:this.align,data:t};var i=new ATGis.POILayer(n,{data:r});e.legend={};e.legend.children=[{id:"legend_"+ATGis.DS.legendID++,checked:1,name:n,title:n,img:(this.icon||"").replace("#{icon}",n),text:n||"",icon:(this.icon||"").replace("#{icon}",n),type:"poilayer",parent:e.legend}];i.spetialQueryable=this.spetialQueryable;i.serviceData=e;ATGis.extend(i.options,this.options);return i}return null}});ATGis.DS.WMS=function(e,t,n,r){ATGis.DS.call(this,e,t,n,r)};ATGis.DS.WMS.prototype=Object.create?Object.create(ATGis.DS.prototype):ATGis.extend({},ATGis.DS.prototype);ATGis.extend(ATGis.DS.WMS.prototype,{constructor:ATGis.DS.WMS,createLayer:function(e){if(e.layertype===ATGis.DS.TAGWMSLAYER){var t=e.layerparam;t.layers=e.layers;var n={};for(var r in e){if(r!=="name"&&r!=="url"&&r!=="layerparam"&&r!=="layers"&&r!=="type"){n[r]=e[r]}}n.restIDs=e.restlayers;n.transitionEffect=t.transitioneffect;var i=new ATGis.WMSLayer(e.name,e.url,t,n);return i}return null}});ATGis.DS.Tile=function(e,t,n,r){ATGis.DS.call(this,e,t,n,r)};ATGis.DS.Tile.prototype=Object.create?Object.create(ATGis.DS.prototype):ATGis.extend({},ATGis.DS.prototype);ATGis.extend(ATGis.DS.Tile.prototype,{constructor:ATGis.DS.Tile,createLayer:function(e){if(e.layertype===ATGis.DS.TAGTILELAYER){var t={};t["name"]=e["name"];t["type"]=e["type"];t["pixel"]=e["pixel"];t["zoomLevels"]=e["levels"];t["imgFormat"]=e["format"];t["legend"]=e["legend"];var n=new ATGis.TileLayer(e.title,e.url,t);return n}return null}})